<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è™šæ‹Ÿè¯•æˆ´ - Splurge Vision</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <style>
    :root {
      --primary: #8f9f91;
      --text-main: #4e544f;
      --text-muted: #7a807b;
      --bg-card: #f4f2ee;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #d6d1c9, #c8cec6, #bfc5bc);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 25px 40px;
      margin-bottom: 30px;
      box-shadow: 0 2px 12px rgba(107, 123, 109, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 2rem;
      color: var(--text-main);
      font-weight: 600;
    }
    
    .back-btn {
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      background: #7e8e80;
      transform: translateY(-1px);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    .video-section {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
    }
    
    .video-wrapper {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    
    #video {
      width: 100%;
      display: block;
      transform: scaleX(-1);
    }
    
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
    }
    
    .controls {
      margin-top: 20px;
      text-align: center;
    }
    
    .control-btn {
      padding: 12px 24px;
      margin: 0 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .control-btn:hover {
      background: #7e8e80;
      transform: translateY(-1px);
    }
    
    .control-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .glasses-selector {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
    }
    
    .glasses-selector h2 {
      font-size: 1.2rem;
      color: var(--text-main);
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .glasses-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .glasses-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(237, 230, 225, 0.3);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .glasses-item:hover {
      background: rgba(237, 230, 225, 0.5);
      transform: translateX(5px);
    }
    
    .glasses-item.active {
      border-color: var(--primary);
      background: rgba(143, 159, 145, 0.15);
    }
    
    .glasses-item img {
      width: 60px;
      height: 40px;
      object-fit: contain;
      margin-right: 15px;
      background: white;
      border-radius: 8px;
      padding: 5px;
    }
    
    .glasses-info {
      flex: 1;
    }
    
    .glasses-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 3px;
    }
    
    .glasses-price {
      font-size: 0.85rem;
      color: var(--primary);
    }
    
    .status-message {
      text-align: center;
      padding: 20px;
      background: rgba(237, 230, 225, 0.4);
      border-radius: 12px;
      margin-bottom: 20px;
      color: var(--text-main);
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .glasses-selector {
        order: -1;
      }
      
      .glasses-list {
        flex-direction: row;
        overflow-x: auto;
      }
      
      .glasses-item {
        flex-direction: column;
        min-width: 120px;
      }
      
      .glasses-item img {
        margin-right: 0;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>è™šæ‹Ÿè¯•æˆ´ï¼ˆé¢éƒ¨è¯†åˆ«ï¼‰</h1>
      <a href="index.html" class="back-btn">è¿”å›é¦–é¡µ</a>
    </div>
    
    <div class="status-message" id="statusMessage">
      ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å¯æ‘„åƒå¤´ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹æ‚¨çš„é¢éƒ¨å¹¶ç²¾å‡†è´´åˆçœ¼é•œ
    </div>
    
    <div class="main-content">
      <div class="video-section">
        <div class="video-wrapper">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas"></canvas>
        </div>
        <div class="controls">
          <button class="control-btn" id="startBtn">å¼€å¯æ‘„åƒå¤´</button>
          <button class="control-btn" id="captureBtn" disabled>æ‹ç…§ä¿å­˜</button>
        </div>
      </div>
      
      <div class="glasses-selector">
        <h2>é€‰æ‹©çœ¼é•œæ¬¾å¼</h2>
        <div class="glasses-list" id="glassesList"></div>
      </div>
    </div>
  </div>
  
  <script>
    const glassesProducts = [
      { id: 1, name: 'SPLURGE VISION NO.1', image: '1å·.png', price: 899 },
      { id: 2, name: 'SPLURGE VISION NO.2', image: '2å·.png', price: 899 },
      { id: 3, name: 'SPLURGE VISION NO.3', image: '3å·.png', price: 899 },
      { id: 4, name: 'SPLURGE VISION NO.4', image: '4å·.png', price: 899 },
      { id: 5, name: 'SPLURGE VISION NO.5', image: '5å·.png', price: 899 },
      { id: 6, name: 'SPLURGE VISION NO.6', image: '6å·.png', price: 899 },
      { id: 7, name: 'SPLURGE VISION NO.7', image: '7å·.png', price: 899 }
    ];
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const statusMessage = document.getElementById('statusMessage');
    const glassesList = document.getElementById('glassesList');
    
    let stream = null;
    let selectedGlasses = null;
    let selectedGlassesId = null; // è¿½è¸ªå½“å‰çœ¼é•œID
    let glassesImage = new Image();
    let faceMesh = null;
    let camera = null;
    let lastFaceLandmarks = null;
    
    // åˆå§‹åŒ–MediaPipe Face Mesh
    function initFaceMesh() {
      faceMesh = new FaceMesh({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }
      });
      
      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      
      faceMesh.onResults(onFaceDetectionResults);
    }
    
    // é¢éƒ¨æ£€æµ‹ç»“æœå›è°ƒ
    function onFaceDetectionResults(results) {
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        lastFaceLandmarks = results.multiFaceLandmarks[0];
        
        // ç»˜åˆ¶çœ¼é•œ
        if (selectedGlasses && glassesImage.complete) {
          drawGlassesOnFace(lastFaceLandmarks);
        }
        
        if (!statusMessage.textContent.includes('å·²é€‰æ‹©') && !statusMessage.textContent.includes('æ£€æµ‹åˆ°é¢éƒ¨')) {
          statusMessage.textContent = 'âœ“ æ£€æµ‹åˆ°é¢éƒ¨ï¼Œè¯·é€‰æ‹©çœ¼é•œæ¬¾å¼';
        }
      } else {
        if (stream && !statusMessage.textContent.includes('æœªæ£€æµ‹åˆ°')) {
          statusMessage.textContent = 'æœªæ£€æµ‹åˆ°é¢éƒ¨ï¼Œè¯·è°ƒæ•´ä½ç½®';
        }
      }
      
      ctx.restore();
    }
    
    // åœ¨é¢éƒ¨ç»˜åˆ¶çœ¼é•œï¼ˆ3Dä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    function drawGlassesOnFace(landmarks) {
      // ä½¿ç”¨å·¦å³çœ¼ä¸­å¿ƒç‚¹
      const leftEyeCenter = landmarks[159];
      const rightEyeCenter = landmarks[386];
      
      // å…³é”®é¢éƒ¨ç‚¹ç”¨äº3Dè®¡ç®—
      const noseBridge = landmarks[6];
      const noseTip = landmarks[1];
      const leftTemple = landmarks[234]; // å·¦å¤ªé˜³ç©´
      const rightTemple = landmarks[454]; // å³å¤ªé˜³ç©´
      const forehead = landmarks[10]; // é¢å¤´ä¸­å¿ƒ
      
      // 1ï¸âƒ£ ä½ç½®ï¼šä¸¤çœ¼ä¸­ç‚¹
      const centerX = ((leftEyeCenter.x + rightEyeCenter.x) / 2) * canvas.width;
      const centerY = ((leftEyeCenter.y + rightEyeCenter.y) / 2) * canvas.height;
      
      // 2ï¸âƒ£ è§’åº¦ï¼šçœ¼ç›è¿çº¿çš„å€¾æ–œè§’ï¼ˆZè½´æ—‹è½¬ï¼‰
      const angle = Math.atan2(
        (rightEyeCenter.y - leftEyeCenter.y) * canvas.height,
        (rightEyeCenter.x - leftEyeCenter.x) * canvas.width
      );
      
      // 3ï¸âƒ£ è®¡ç®—ä¸¤çœ¼è·ç¦»ï¼ˆåŸºç¡€ç¼©æ”¾ï¼‰
      const eyeDistance = Math.sqrt(
        Math.pow((rightEyeCenter.x - leftEyeCenter.x) * canvas.width, 2) +
        Math.pow((rightEyeCenter.y - leftEyeCenter.y) * canvas.height, 2)
      );
      
      // 4ï¸âƒ£ 3Dæ·±åº¦è®¡ç®—ï¼ˆä½¿ç”¨Zåæ ‡ï¼‰
      // MediaPipeæä¾›çš„zå€¼è¡¨ç¤ºæ·±åº¦ï¼ˆè´Ÿå€¼è¡¨ç¤ºè¿œç¦»æ‘„åƒå¤´ï¼‰
      const leftEyeZ = leftEyeCenter.z || 0;
      const rightEyeZ = rightEyeCenter.z || 0;
      const avgEyeZ = (leftEyeZ + rightEyeZ) / 2;
      
      // æ ¹æ®æ·±åº¦è°ƒæ•´æ•´ä½“ç¼©æ”¾ï¼ˆè„¸ç¦»é•œå¤´è¶Šè¿œï¼Œçœ¼é•œè¶Šå°ï¼‰
      const depthScale = 1 + avgEyeZ * 0.5;
      
      // 5ï¸âƒ£ Yè½´æ—‹è½¬ï¼ˆå·¦å³è½¬å¤´ï¼‰
      const faceAngleX = (noseTip.x - noseBridge.x) * canvas.width;
      const yRotation = Math.atan2(faceAngleX, 80); // Yè½´æ—‹è½¬è§’åº¦
      
      // 6ï¸âƒ£ Xè½´æ—‹è½¬ï¼ˆä¸Šä¸‹ç‚¹å¤´ï¼‰
      const faceAngleY = (noseTip.y - forehead.y) * canvas.height;
      const xRotation = Math.atan2(faceAngleY, 150) * 0.5; // Xè½´æ—‹è½¬è§’åº¦
      
      // 7ï¸âƒ£ 3Dé€è§†å˜æ¢å‚æ•°ï¼ˆé’ˆå¯¹çœ¼é•œè…¿ä¼˜åŒ–ï¼‰
      // æ°´å¹³ç¼©æ”¾ï¼šä¾§è„¸æ—¶çœ¼é•œå®½åº¦å‹ç¼©ï¼ˆå¢å¼ºæ•ˆæœè®©é•œè…¿è´´åˆï¼‰
      const scaleX = Math.pow(Math.cos(yRotation), 1.5) * depthScale; // ä½¿ç”¨å¹‚æ¬¡å¢å¼ºå‹ç¼©
      
      // å‚ç›´ç¼©æ”¾ï¼šä½å¤´/æŠ¬å¤´æ—¶é«˜åº¦è°ƒæ•´
      const scaleY = (1 - Math.abs(xRotation) * 0.3) * depthScale;
      
      // å€¾æ–œå˜å½¢ï¼šä¾§è„¸æ—¶çš„é€è§†æ•ˆæœï¼ˆå¢å¼ºé•œè…¿è´´åˆæ„Ÿï¼‰
      const skewX = Math.sin(yRotation) * 0.4; // å¢å¤§å€¾æ–œç³»æ•°
      const skewY = Math.sin(xRotation) * 0.15;
      
      // æ ¹æ®è„¸éƒ¨è§’åº¦è°ƒæ•´çœ¼é•œå®½åº¦ï¼ˆä¾§è„¸æ—¶é•œè…¿è‡ªç„¶æ”¶ç¼©ï¼‰
      const templeAdjustment = Math.abs(Math.sin(yRotation)) * 0.3; // é•œè…¿æ”¶ç¼©ç³»æ•°
      
      // 8ï¸âƒ£ çœ¼é•œå°ºå¯¸è®¡ç®—ï¼ˆè€ƒè™‘é•œè…¿æ”¶ç¼©ï¼‰
      const baseWidth = eyeDistance * (5.5 - templeAdjustment); // ä¾§è„¸æ—¶å‡å°å®½åº¦
      const glassesWidth = baseWidth * scaleX;
      const glassesHeight = (baseWidth * (glassesImage.height / glassesImage.width)) * scaleY;
      
      // 9ï¸âƒ£ é€æ˜åº¦è°ƒæ•´ï¼ˆå¤§è§’åº¦ä¾§è„¸æ—¶é™ä½é€æ˜åº¦ï¼‰
      const angleOpacity = Math.max(0.3, Math.cos(yRotation) * 0.9);
      
      // ğŸ”Ÿ ç»˜åˆ¶çœ¼é•œ
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(angle);
      
      // åº”ç”¨3Dé€è§†å˜å½¢çŸ©é˜µ
      // transform(a, b, c, d, e, f)
      // a=æ°´å¹³ç¼©æ”¾, b=å‚ç›´å€¾æ–œ, c=æ°´å¹³å€¾æ–œ, d=å‚ç›´ç¼©æ”¾, e=æ°´å¹³ç§»åŠ¨, f=å‚ç›´ç§»åŠ¨
      ctx.transform(
        Math.abs(scaleX), 
        skewY, 
        skewX, 
        scaleY, 
        0, 
        0
      );
      
      ctx.globalAlpha = angleOpacity;
      ctx.drawImage(
        glassesImage,
        -baseWidth / 2,
        -(baseWidth * (glassesImage.height / glassesImage.width)) / 2,
        baseWidth,
        baseWidth * (glassesImage.height / glassesImage.width)
      );
      ctx.restore();
    }
    
    // æ¸²æŸ“çœ¼é•œåˆ—è¡¨
    function renderGlassesList() {
      glassesList.innerHTML = glassesProducts.map(item => `
        <div class="glasses-item" data-id="${item.id}" data-image="${item.image}">
          <img src="${item.image}" alt="${item.name}">
          <div class="glasses-info">
            <div class="glasses-name">${item.name}</div>
            <div class="glasses-price">Â¥${item.price}</div>
          </div>
        </div>
      `).join('');
      
      document.querySelectorAll('.glasses-item').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.glasses-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          
          const imageSrc = this.dataset.image;
          const glassesId = parseInt(this.dataset.id); // è·å–çœ¼é•œID
          selectedGlasses = imageSrc;
          selectedGlassesId = glassesId;
          glassesImage.src = imageSrc;
          statusMessage.textContent = `âœ“ å·²é€‰æ‹©ï¼š${this.querySelector('.glasses-name').textContent}`;
        });
      });
    }
    
    // å¼€å¯æ‘„åƒå¤´
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: 640, 
            height: 480,
            facingMode: 'user'
          } 
        });
        video.srcObject = stream;
        
        video.addEventListener('loadedmetadata', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          startBtn.textContent = 'å…³é—­æ‘„åƒå¤´';
          captureBtn.disabled = false;
          statusMessage.textContent = 'æ­£åœ¨åˆå§‹åŒ–é¢éƒ¨æ£€æµ‹...';
          
          // å¯åŠ¨MediaPipeé¢éƒ¨æ£€æµ‹
          if (!camera) {
            camera = new Camera(video, {
              onFrame: async () => {
                await faceMesh.send({image: video});
              },
              width: 640,
              height: 480
            });
            camera.start();
          }
        });
      } catch (err) {
        console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err);
        statusMessage.textContent = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
      }
    }
    
    // å…³é—­æ‘„åƒå¤´
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        stream = null;
        if (camera) {
          camera.stop();
        }
        startBtn.textContent = 'å¼€å¯æ‘„åƒå¤´';
        captureBtn.disabled = true;
        statusMessage.textContent = 'æ‘„åƒå¤´å·²å…³é—­';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }
    
    // æ‹ç…§ä¿å­˜
    function capturePhoto() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');
      
      // ç»˜åˆ¶è§†é¢‘å¸§ï¼ˆé•œåƒï¼‰
      tempCtx.save();
      tempCtx.scale(-1, 1);
      tempCtx.drawImage(video, -tempCanvas.width, 0, tempCanvas.width, tempCanvas.height);
      tempCtx.restore();
      
      // ç»˜åˆ¶çœ¼é•œ
      if (lastFaceLandmarks && selectedGlasses && glassesImage.complete) {
        const adjustedLandmarks = lastFaceLandmarks.map(lm => ({
          x: 1 - lm.x,
          y: lm.y,
          z: lm.z
        }));
        
        const leftEyeInner = adjustedLandmarks[133];
        const rightEyeInner = adjustedLandmarks[263];
        
        const eyeDistance = Math.sqrt(
          Math.pow((rightEyeInner.x - leftEyeInner.x) * tempCanvas.width, 2) +
          Math.pow((rightEyeInner.y - leftEyeInner.y) * tempCanvas.height, 2)
        );
        
        const centerX = ((leftEyeInner.x + rightEyeInner.x) / 2) * tempCanvas.width;
        const centerY = ((leftEyeInner.y + rightEyeInner.y) / 2) * tempCanvas.height;
        
        const glassesWidth = eyeDistance * 1.8;
        const glassesHeight = glassesWidth * (glassesImage.height / glassesImage.width);
        
        const angle = Math.atan2(
          (rightEyeInner.y - leftEyeInner.y) * tempCanvas.height,
          (rightEyeInner.x - leftEyeInner.x) * tempCanvas.width
        );
        
        tempCtx.save();
        tempCtx.translate(centerX, centerY);
        tempCtx.rotate(angle);
        tempCtx.globalAlpha = 0.9;
        tempCtx.drawImage(
          glassesImage,
          -glassesWidth / 2,
          -glassesHeight / 2,
          glassesWidth,
          glassesHeight
        );
        tempCtx.restore();
      }
      
      // ä¸‹è½½å›¾ç‰‡
      tempCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `splurge-vision-try-on-${Date.now()}.jpg`;
        a.click();
        URL.revokeObjectURL(url);
        statusMessage.textContent = 'âœ“ ç…§ç‰‡å·²ä¿å­˜ï¼';
      });
    }
    
    // äº‹ä»¶ç›‘å¬
    startBtn.addEventListener('click', () => {
      if (stream) {
        stopCamera();
      } else {
        startCamera();
      }
    });
    
    captureBtn.addEventListener('click', capturePhoto);
    
    // åˆå§‹åŒ–
    initFaceMesh();
    renderGlassesList();
  </script>
</body>
</html>
